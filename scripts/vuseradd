#!/bin/bash
#
# useradd(8) wrapper for vservers
#
# Copyright (c) 2004  The Trustees of Princeton University (Trustees).
#
# $Id: vuseradd,v 1.14 2004/10/20 21:45:15 mef Exp $
#

: ${UTIL_VSERVER_VARS:=$(dirname $0)/util-vserver-vars}
test -e "$UTIL_VSERVER_VARS" || {
    echo "Can not find util-vserver installation; aborting..."
    exit 1
}
. "$UTIL_VSERVER_VARS"

usage()
{
    echo "usage: $0 name"
    exit 1
}

[ -z "$1" ] && usage
NAME=$1

# add slices group if not already present
groupadd slices 2>/dev/null || :

# add user
useradd -g slices -s /bin/vsh $NAME

USERID=$(awk -F: "\$1 == \"$NAME\" { print \$3 }" < /etc/passwd)
GROUPID=$(awk -F: "\$1 == \"slices\" { print \$3 }" < /etc/group)

# create vserver configuration file
if [ ! -f /etc/vservers/$NAME.conf ] ; then
    sed \
	-e "s/.*S_CONTEXT=.*/S_CONTEXT=$USERID/" \
	-e "s/.*ONBOOT=.*/ONBOOT=yes/" \
	< $PKGLIBDIR/sample.conf \
	> /etc/vservers/$NAME.conf
fi

if [ ! -d "$VROOTDIR/$NAME" ] ; then
    # check the cache
    shopt -s nullglob
    for i in "$VROOTDIR/.vcache/"* ; do
	[ -d "$i" ] && mv "$i" "$VROOTDIR/$NAME" && break
    done
    # build vserver
    if [ ! -d "$VROOTDIR/$NAME" ] ; then
	# build image in .vtmp
	TMP=$(mktemp -d "$VROOTDIR/.vtmp/$NAME.XXXXXX")
	"$PKGLIBDIR/vbuild" "$VROOTDIR/vserver-reference" "$TMP"
	RETVAL=$?
	# move it to .vcache when complete
	if [ $RETVAL -ne 0 ] || \
	   [ $(du -s "$TMP" | awk "{ print \$1 }") -lt \
             $(du -s "$VROOTDIR/vserver-reference" | awk "{ print \$1 }") ] ; then
	    echo "Error $RETVAL building $VROOTDIR/$NAME"
	    chattr -R -i "$TMP"
	    rm -rf "$TMP"
	    exit $RETVAL
	else
	    mv "$TMP" "$VROOTDIR/$NAME"
	fi
    fi
fi

if [ -d "$VROOTDIR/$NAME" ] ; then
    # fix permissions
    chmod 755 "$VROOTDIR/$NAME"

    # add user in vserver
    vserver $NAME suexec root groupadd -g $GROUPID slices
    vserver $NAME suexec root useradd -u $USERID -g $GROUPID -p '' $NAME

    # add an unrestricted entry to /etc/sudoers file
    if [ -f "$VROOTDIR/$NAME/etc/sudoers" ] && \
       ! grep -q "^$NAME" "$VROOTDIR/$NAME/etc/sudoers" ; then
	echo "$NAME	ALL=(ALL)	ALL" >> "$VROOTDIR/$NAME/etc/sudoers"
    fi
fi

# turn resource management on for vserver $NAME
service resman start $NAME
